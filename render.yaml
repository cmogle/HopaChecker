# Render Blueprint specification
# https://render.com/docs/blueprint-spec

services:
  # Web service for search UI, API, and monitoring
  - type: web
    name: hopachecker-web
    runtime: node
    buildCommand: npm install && npm run build
    startCommand: node dist/server.js
    disk:
      name: hopachecker-data
      mountPath: /data
      sizeGB: 1
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATA_PATH
        value: /data
      - key: PORT
        value: 3000
      - key: TARGET_URL
        sync: false
      - key: MONITOR_SECRET
        generateValue: true
      - key: TWILIO_ACCOUNT_SID
        sync: false
      - key: TWILIO_AUTH_TOKEN
        sync: false
      - key: TWILIO_WHATSAPP_FROM
        sync: false
      - key: NOTIFY_WHATSAPP
        sync: false

  # Cron job that triggers the monitor endpoint every 5 minutes
  - type: cron
    name: hopachecker-cron
    runtime: node
    schedule: "*/5 * * * *"
    buildCommand: echo "No build needed"
    startCommand: |
      APP_URL="${RENDER_SERVICE_URL:-https://hopachecker-web.onrender.com}"
      curl -X POST "$APP_URL/api/monitor?key=${MONITOR_SECRET}" \
        -H "Content-Type: application/json" \
        -H "x-monitor-key: ${MONITOR_SECRET}" \
        --max-time 120 \
        --retry 2 \
        || echo "Monitor request failed"
    envVars:
      - key: MONITOR_SECRET
        fromService:
          type: web
          name: hopachecker-web
          envVarKey: MONITOR_SECRET

  # Hourly heartbeat - sends WhatsApp notification to confirm service is running
  - type: cron
    name: hopachecker-heartbeat
    runtime: node
    schedule: "0 * * * *"
    buildCommand: echo "No build needed"
    startCommand: |
      APP_URL="${RENDER_SERVICE_URL:-https://hopachecker-web.onrender.com}"
      curl -X POST "$APP_URL/api/heartbeat?key=${MONITOR_SECRET}" \
        -H "Content-Type: application/json" \
        -H "x-monitor-key: ${MONITOR_SECRET}" \
        --max-time 30 \
        --retry 2 \
        || echo "Heartbeat request failed"
    envVars:
      - key: MONITOR_SECRET
        fromService:
          type: web
          name: hopachecker-web
          envVarKey: MONITOR_SECRET
